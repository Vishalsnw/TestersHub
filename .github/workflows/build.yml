name: Build Release APK and AAB

on:
  push:
    branches: [ main, release ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle 8.4
        run: |
          mkdir -p gradle/wrapper
          curl -sL https://services.gradle.org/distributions/gradle-8.4-all.zip -o /tmp/gradle-8.4.zip
          unzip -n -q /tmp/gradle-8.4.zip -d /tmp/
          echo "/tmp/gradle-8.4/bin" >> $GITHUB_PATH
          gradle --version

      # ğŸ” CREATE RELEASE KEYSTORE
      - name: Create Keystore
        run: |
          mkdir -p ~/.android
          keytool -genkey -v \
            -keystore ~/.android/testershub_release.keystore \
            -keyalg RSA -keysize 2048 \
            -validity 10000 \
            -alias testershub_key \
            -dname "CN=TestersHub,O=TestersHub Inc,L=Global,C=US" \
            -storepass TestersHub@2026#SecureKey \
            -keypass TestersHub@2026#SecureKey

      # ğŸ”‘ PRINT SHA-1 & SHA-256 FOR FIREBASE
      - name: Get SHA-1 and SHA-256
        run: |
          echo "===== SIGNING CERTIFICATE DETAILS ====="
          keytool -list -v \
            -keystore $HOME/.android/testershub_release.keystore \
            -alias testershub_key \
            -storepass TestersHub@2026#SecureKey \
            -keypass TestersHub@2026#SecureKey | grep -E "SHA1:|SHA256:"

      # ğŸ— BUILD RELEASE APK
      - name: Build Release APK
        run: |
          gradle assembleRelease \
            -Pandroid.injected.signing.store.file=$HOME/.android/testershub_release.keystore \
            -Pandroid.injected.signing.store.password=TestersHub@2026#SecureKey \
            -Pandroid.injected.signing.key.alias=testershub_key \
            -Pandroid.injected.signing.key.password=TestersHub@2026#SecureKey

      # ğŸ“¦ BUILD RELEASE AAB
      - name: Build Release AAB
        run: |
          gradle bundleRelease \
            -Pandroid.injected.signing.store.file=$HOME/.android/testershub_release.keystore \
            -Pandroid.injected.signing.store.password=TestersHub@2026#SecureKey \
            -Pandroid.injected.signing.key.alias=testershub_key \
            -Pandroid.injected.signing.key.password=TestersHub@2026#SecureKey

      - name: List Build Outputs
        run: |
          echo "=== Release APK ==="
          ls -lh app/build/outputs/apk/release/
          echo ""
          echo "=== Release AAB ==="
          ls -lh app/build/outputs/bundle/release/

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: testershub-release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: testershub-release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Build Summary
        run: |
          echo "âœ… Build Complete!"
          echo "ğŸ“¦ APK & AAB generated"
          echo "ğŸ”‘ SHA fingerprints printed above for Firebase"
